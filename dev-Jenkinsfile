pipeline {

    agent any

    post {
      failure {
        updateGitlabCommitStatus name: 'build', state: 'failed'
      }
      success {
        updateGitlabCommitStatus name: 'build', state: 'success'
      }
      aborted {
        updateGitlabCommitStatus name: 'build', state: 'canceled'
      }
    }

    stages {

        stage('Git Pull') {
            steps {
                git branch: 'PPBAP-23-development-pipeline', credentialsId: 'sdyszews', url: 'https://gitlab-stud.elka.pw.edu.pl/pkosmala/pis22z-projekt-baza-aktow-prawnych'
            }
        }

        stage('Gradle Build') {
            steps {
                updateGitlabCommitStatus name: 'build', state: 'running'
                sh '/home/pkosmala/.sdkman/candidates/gradle/current/bin/gradle wrapper build'
            }
        }


        stage('Docker') {
            steps {
                sh 'docker build --platform linux/amd64 -t pisproject-api .'
                sh 'docker-compose up -d'
            }
        }

        stage('Test') {
          steps {
                sh './gradlew clean test --info'
                sh './gradlew clean integration --info'
          }
        }

        stage('SonarQube Analysis') {
            steps{
                withSonarQubeEnv(installationName: 'pisproject-sq') {
                    sh './gradlew sonarqube'
                }
            }
        }

        stage('Publish to nexus') {
          steps {
                sh './gradlew incrementVersion --versionIncrementType=PATCH'
                sh './gradlew publish'
          }
        }

        stage('Cleanup') {
          steps {
                sh 'docker-compose down'
          }
        }
    }
}
